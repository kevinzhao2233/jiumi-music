# 啾咪音乐

## 发现页轮播图

**插件**：[vue-awesome-swiper](https://github.com/surmon-china/vue-awesome-swiper)

**问题**：尽管使用了动态加载，但是在 `mounted()` 或 `created()` 里面异步请求的资源无法添加到轮播图里面

**解决**：nuxt 有异步数据的功能，可以在组件挂在前就发起异步请求，将轮播图的数据在这里请求即可。如果适用普通的 vue，暂时还不明白怎么解决，可能这个问题只是当时版本的 bug

## axios 配置

nuxt 内置了 axios，并已经有封装了，但是并没有做错误处理等等，所以这部分需要自己实现。

首先新建文件 plugins/axios.js，在这里是可以取到 nuxt 的上下文变量（[contex](https://zh.nuxtjs.org/api/context)）的，可以通过这些变量做错误处理。

```js
// plugins/axios.js

export default function({ $axios, error }) {
  // 拦截请求
  $axios.onRequest(config => {
    console.log('Making request to ' + config.url)
  })
	// 拦截响应错误
  $axios.onError(err => {
    // 下面这两句并不是所有 API 请求都适用
    const statusCode = parseInt(err.response && err.response.status)
    const message = parseInt(err.response && err.response.data.code)
    error({
      statusCode,
      message
    })
    switch (code) {
      case 400:
        console.log('状态码：400 ━━(￣ー￣*|||━━')
        break
       ……
  })
}
```

然后引入该插件

```js
// nuxt.config.js

plugins: [
  '~/plugins/axios'
]
```

如果遇到错误，可以使用 `error()` 跳转到 nuxt 默认配置的错误页（layout/error.vue），也可以使用 `redirect()` 跳转到其他自定义的页面

## 虚拟滚动

这个项目为了尽可能提高用户体验，暂时并没有在歌单列表中使用分页，但是当歌曲有 200 首以上时，滚动的时候就能明显感觉到卡顿，于是采用了虚拟滚动的解决方案，虚拟滚动的原理比较简单，就是让需要在试图中显示的部分渲染到 DOM 中，其他部分都不渲染，在滚动时不断更替 DOM。

**插件**：[vue-virtual-scroller](https://github.com/Akryum/vue-virtual-scroller)

我的使用过程中总感觉这个插件可以保证一个性能下限，并再次基础上做了一定的优化，对于数量较少的情况下（60首一下）不开启反而感觉更流畅，当然了对于 1000 首歌这样的情况，优化极其明显，下面可以看一个对比

![image-20200416205748596](%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3.assets/image-20200416205748596.png)

这两部分都是页面获取到数据后渲染阶段的情况，左边的时未开启虚拟滚动，右边是开启虚拟滚动。效果非常明显，左边的花了 1758ms 做渲染，甚至给我报了 “long task” 的警告，右边只花了 56ms ，但实际上右边的还包括了其他的一些渲染任务，实际上只做列表渲染的时间只有不到 40ms，这个巨大的差距就证明了虚拟滚动确实可以为大量列表数据渲染带来极大的提升。

**使用方法**：

首先加入插件（如果是普通 vue 项目直接在 main.js 中引入即可）

```js
// plugins/vue-virtual-scroller.js

import 'vue-virtual-scroller/dist/vue-virtual-scroller.css';
import Vue from 'vue';
import VueVirtualScroller from 'vue-virtual-scroller';

Vue.use(VueVirtualScroller);
```

然后引入

```js
// nuxt.config.js

plugins: [
	'~/plugins/vue-virtual-scroller'
]
```

在组件中使用

```vue
<RecycleScroller
  v-if="list.length > 60"
  :items="list"
  :item-size="62"
  key-fild="id"
  page-mode
  v-slot="{ item, index }"
>
  <PlaylistItem :item="item" :index="index" />
</RecycleScroller>
```

下面依次解释一下上述参数的含义

- `:items`：需要渲染的数组，或对象
- `:item-size`：每一项的高度（px），如果是横向排列，这里就是宽度
-   `key-fild`：key 值
-   `page-mode`：一种模式（根据插件作者介绍这一属性可有可无，但是我的项目如果不用这个模式并不会开启虚拟滚动）
-   `v-slot="{ item, index }"`：相当于 `v-for="(item, index) in list"` 中获取 item 和 index。这两个属性便可以在里面使用，item 就是每一首歌，index 就是遍历的序号

这一插件的好处不言而喻，但是也有一个问题，就是没办法加过度动画 `<transition>`